"use strict";

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; var ownKeys = Object.keys(source); if (typeof Object.getOwnPropertySymbols === 'function') { ownKeys = ownKeys.concat(Object.getOwnPropertySymbols(source).filter(function (sym) { return Object.getOwnPropertyDescriptor(source, sym).enumerable; })); } ownKeys.forEach(function (key) { _defineProperty(target, key, source[key]); }); } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

const fs = require('fs');

const path = require('path');

const I18N = require('@ladjs/i18n');

const _ = require('lodash');

const autoBind = require('auto-bind');

const consolidate = require('consolidate');

const debug = require('debug')('email-templates');

const getPaths = require('get-paths');

const htmlToText = require('html-to-text');

const is = require('@sindresorhus/is');

const juice = require('juice');

const nodemailer = require('nodemailer');

const pify = require('pify');

const previewEmail = require('preview-email'); // promise version of `juice.juiceResources`


const juiceResources = (html, options) => {
  return new Promise((resolve, reject) => {
    juice.juiceResources(html, options, (err, html) => {
      if (err) return reject(err);
      resolve(html);
    });
  });
};

const env = (process.env.NODE_ENV || 'development').toLowerCase();
const stat = pify(fs.stat);
const readFile = pify(fs.readFile);

class Email {
  constructor(config = {}) {
    debug('config passed %O', config); // 2.x backwards compatible support

    if (config.juiceOptions) {
      config.juiceResources = config.juiceOptions;
      delete config.juiceOptions;
    }

    if (config.disableJuice) {
      config.juice = false;
      delete config.disableJuice;
    }

    if (config.render) {
      config.customRender = true;
    }

    this.config = _.merge({
      views: {
        // directory where email templates reside
        root: path.resolve('emails'),
        options: {
          // default file extension for template
          extension: 'pug',
          map: {
            hbs: 'handlebars',
            njk: 'nunjucks'
          },
          engineSource: consolidate
        },
        // locals to pass to templates for rendering
        locals: {
          // turn on caching for non-development environments
          cache: !['development', 'test'].includes(env),
          // pretty is automatically set to `false` for subject/text
          pretty: true
        }
      },
      // <https://nodemailer.com/message/>
      message: {},
      send: !['development', 'test'].includes(env),
      preview: env === 'development',
      // <https://github.com/ladjs/i18n>
      // set to an object to configure and enable it
      i18n: false,
      // pass a custom render function if necessary
      render: this.render.bind(this),
      customRender: false,
      // force text-only rendering of template (disregards template folder)
      textOnly: false,
      // <https://github.com/werk85/node-html-to-text>
      htmlToText: {
        ignoreImage: true
      },
      subjectPrefix: false,
      // <https://github.com/Automattic/juice>
      juice: true,
      juiceResources: {
        preserveImportant: true,
        webResources: {
          relativeTo: path.resolve('build'),
          images: false
        }
      },
      // pass a transport configuration object or a transport instance
      // (e.g. an instance is created via `nodemailer.createTransport`)
      // <https://nodemailer.com/transports/>
      transport: {}
    }, config); // override existing method

    this.render = this.config.render;
    if (!_.isFunction(this.config.transport.sendMail)) this.config.transport = nodemailer.createTransport(this.config.transport);
    debug('transformed config %O', this.config);
    autoBind(this);
  } // shorthand use of `juiceResources` with the config
  // (mainly for custom renders like from a database)


  juiceResources(html) {
    return juiceResources(html, this.config.juiceResources);
  } // a simple helper function that gets the actual file path for the template


  async getTemplatePath(template) {
    const [root, view] = path.isAbsolute(template) ? [path.dirname(template), path.basename(template)] : [this.config.views.root, template];
    const paths = await getPaths(root, view, this.config.views.options.extension);
    const filePath = path.resolve(root, paths.rel);
    return {
      filePath,
      paths
    };
  } // returns true or false if a template exists
  // (uses same look-up approach as `render` function)


  async templateExists(view) {
    try {
      const {
        filePath
      } = await this.getTemplatePath(view);
      const stats = await stat(filePath);
      if (!stats.isFile()) throw new Error(`${filePath} was not a file`);
      return true;
    } catch (err) {
      debug('templateExists', err);
      return false;
    }
  }

  async checkAndRender(type, template, locals) {
    const str = `${template}/${type}`;

    if (!this.config.customRender) {
      const exists = await this.templateExists(str);
      if (!exists) return;
    }

    return this.render(str, _objectSpread({}, locals, type === 'html' ? {} : {
      pretty: false
    }));
  } // promise version of consolidate's render
  // inspired by koa-views and re-uses the same config
  // <https://github.com/queckezz/koa-views>


  async render(view, locals = {}) {
    const {
      map,
      engineSource
    } = this.config.views.options;
    const {
      filePath,
      paths
    } = await this.getTemplatePath(view);

    if (paths.ext === 'html' && !map) {
      const res = await readFile(filePath, 'utf8');
      return res;
    }

    const engineName = map && map[paths.ext] ? map[paths.ext] : paths.ext;
    const renderFn = engineSource[engineName];
    if (!engineName || !renderFn) throw new Error(`Engine not found for the ".${paths.ext}" file extension`);

    if (_.isObject(this.config.i18n)) {
      const i18n = new I18N(_objectSpread({}, this.config.i18n, {
        register: locals
      })); // support `locals.user.last_locale`
      // (e.g. for <https://lad.js.org>)

      if (_.isObject(locals.user) && _.isString(locals.user.last_locale)) locals.locale = locals.user.last_locale;
      if (_.isString(locals.locale)) i18n.setLocale(locals.locale);
    }

    const res = await pify(renderFn)(filePath, locals); // transform the html with juice using remote paths
    // google now supports media queries
    // https://developers.google.com/gmail/design/reference/supported_css

    if (!this.config.juice) return res;
    const html = await this.juiceResources(res);
    return html;
  }

  async renderAll(template, locals = {}, nodemailerMessage = {}) {
    const message = _objectSpread({}, nodemailerMessage);

    if (template) {
      const [subject, html, text] = await Promise.all(['subject', 'html', 'text'].map(type => this.checkAndRender(type, template, locals)));
      if (subject) message.subject = subject.trim();
      if (html) message.html = html;
      if (text) message.text = text;
    }

    if (message.subject && this.config.subjectPrefix) message.subject = this.config.subjectPrefix + message.subject;
    if (this.config.htmlToText && message.html && !message.text) // we'd use nodemailer-html-to-text plugin
      // but we really don't need to support cid
      // <https://github.com/andris9/nodemailer-html-to-text>
      message.text = htmlToText.fromString(message.html, this.config.htmlToText); // if we only want a text-based version of the email

    if (this.config.textOnly) delete message.html; // if no subject, html, or text content exists then we should
    // throw an error that says at least one must be found
    // otherwise the email would be blank (defeats purpose of email-templates)

    if ((!is.string(message.subject) || is.emptyStringOrWhitespace(message.subject)) && (!is.string(message.text) || is.emptyStringOrWhitespace(message.text)) && (!is.string(message.html) || is.emptyStringOrWhitespace(message.html)) && _.isArray(message.attachments) && _.isEmpty(message.attachments)) throw new Error(`No content was passed for subject, html, text, nor attachments message props. Check that the files for the template "${template}" exist.`);
    return message;
  }

  async send(options = {}) {
    options = _objectSpread({
      template: '',
      message: {},
      locals: {}
    }, options);
    let {
      template,
      message,
      locals
    } = options;
    const attachments = message.attachments || this.config.message.attachments || [];
    message = _.defaultsDeep({}, _.omit(message, 'attachments'), _.omit(this.config.message, 'attachments'));
    locals = _.defaultsDeep({}, this.config.views.locals, locals);
    if (attachments) message.attachments = attachments;
    debug('template %s', template);
    debug('message %O', message);
    debug('locals (keys only): %O', Object.keys(locals)); // get all available templates

    const obj = await this.renderAll(template, locals, message); // assign the object variables over to the message

    Object.assign(message, obj);

    if (this.config.preview) {
      debug('using `preview-email` to preview email');
      if (_.isObject(this.config.preview)) await previewEmail(message, this.config.preview);else await previewEmail(message);
    }

    if (!this.config.send) {
      debug('send disabled so we are ensuring JSONTransport'); // <https://github.com/nodemailer/nodemailer/issues/798>
      // if (this.config.transport.name !== 'JSONTransport')

      this.config.transport = nodemailer.createTransport({
        jsonTransport: true
      });
    }

    const res = await this.config.transport.sendMail(message);
    debug('message sent');
    res.originalMessage = message;
    return res;
  }

}

module.exports = Email;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJmcyIsInJlcXVpcmUiLCJwYXRoIiwiSTE4TiIsIl8iLCJhdXRvQmluZCIsImNvbnNvbGlkYXRlIiwiZGVidWciLCJnZXRQYXRocyIsImh0bWxUb1RleHQiLCJpcyIsImp1aWNlIiwibm9kZW1haWxlciIsInBpZnkiLCJwcmV2aWV3RW1haWwiLCJqdWljZVJlc291cmNlcyIsImh0bWwiLCJvcHRpb25zIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJlcnIiLCJlbnYiLCJwcm9jZXNzIiwiTk9ERV9FTlYiLCJ0b0xvd2VyQ2FzZSIsInN0YXQiLCJyZWFkRmlsZSIsIkVtYWlsIiwiY29uc3RydWN0b3IiLCJjb25maWciLCJqdWljZU9wdGlvbnMiLCJkaXNhYmxlSnVpY2UiLCJyZW5kZXIiLCJjdXN0b21SZW5kZXIiLCJtZXJnZSIsInZpZXdzIiwicm9vdCIsImV4dGVuc2lvbiIsIm1hcCIsImhicyIsIm5qayIsImVuZ2luZVNvdXJjZSIsImxvY2FscyIsImNhY2hlIiwiaW5jbHVkZXMiLCJwcmV0dHkiLCJtZXNzYWdlIiwic2VuZCIsInByZXZpZXciLCJpMThuIiwiYmluZCIsInRleHRPbmx5IiwiaWdub3JlSW1hZ2UiLCJzdWJqZWN0UHJlZml4IiwicHJlc2VydmVJbXBvcnRhbnQiLCJ3ZWJSZXNvdXJjZXMiLCJyZWxhdGl2ZVRvIiwiaW1hZ2VzIiwidHJhbnNwb3J0IiwiaXNGdW5jdGlvbiIsInNlbmRNYWlsIiwiY3JlYXRlVHJhbnNwb3J0IiwiZ2V0VGVtcGxhdGVQYXRoIiwidGVtcGxhdGUiLCJ2aWV3IiwiaXNBYnNvbHV0ZSIsImRpcm5hbWUiLCJiYXNlbmFtZSIsInBhdGhzIiwiZmlsZVBhdGgiLCJyZWwiLCJ0ZW1wbGF0ZUV4aXN0cyIsInN0YXRzIiwiaXNGaWxlIiwiRXJyb3IiLCJjaGVja0FuZFJlbmRlciIsInR5cGUiLCJzdHIiLCJleGlzdHMiLCJleHQiLCJyZXMiLCJlbmdpbmVOYW1lIiwicmVuZGVyRm4iLCJpc09iamVjdCIsInJlZ2lzdGVyIiwidXNlciIsImlzU3RyaW5nIiwibGFzdF9sb2NhbGUiLCJsb2NhbGUiLCJzZXRMb2NhbGUiLCJyZW5kZXJBbGwiLCJub2RlbWFpbGVyTWVzc2FnZSIsInN1YmplY3QiLCJ0ZXh0IiwiYWxsIiwidHJpbSIsImZyb21TdHJpbmciLCJzdHJpbmciLCJlbXB0eVN0cmluZ09yV2hpdGVzcGFjZSIsImlzQXJyYXkiLCJhdHRhY2htZW50cyIsImlzRW1wdHkiLCJkZWZhdWx0c0RlZXAiLCJvbWl0IiwiT2JqZWN0Iiwia2V5cyIsIm9iaiIsImFzc2lnbiIsImpzb25UcmFuc3BvcnQiLCJvcmlnaW5hbE1lc3NhZ2UiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxNQUFNQSxFQUFFLEdBQUdDLE9BQU8sQ0FBQyxJQUFELENBQWxCOztBQUNBLE1BQU1DLElBQUksR0FBR0QsT0FBTyxDQUFDLE1BQUQsQ0FBcEI7O0FBQ0EsTUFBTUUsSUFBSSxHQUFHRixPQUFPLENBQUMsYUFBRCxDQUFwQjs7QUFDQSxNQUFNRyxDQUFDLEdBQUdILE9BQU8sQ0FBQyxRQUFELENBQWpCOztBQUNBLE1BQU1JLFFBQVEsR0FBR0osT0FBTyxDQUFDLFdBQUQsQ0FBeEI7O0FBQ0EsTUFBTUssV0FBVyxHQUFHTCxPQUFPLENBQUMsYUFBRCxDQUEzQjs7QUFDQSxNQUFNTSxLQUFLLEdBQUdOLE9BQU8sQ0FBQyxPQUFELENBQVAsQ0FBaUIsaUJBQWpCLENBQWQ7O0FBQ0EsTUFBTU8sUUFBUSxHQUFHUCxPQUFPLENBQUMsV0FBRCxDQUF4Qjs7QUFDQSxNQUFNUSxVQUFVLEdBQUdSLE9BQU8sQ0FBQyxjQUFELENBQTFCOztBQUNBLE1BQU1TLEVBQUUsR0FBR1QsT0FBTyxDQUFDLGtCQUFELENBQWxCOztBQUNBLE1BQU1VLEtBQUssR0FBR1YsT0FBTyxDQUFDLE9BQUQsQ0FBckI7O0FBQ0EsTUFBTVcsVUFBVSxHQUFHWCxPQUFPLENBQUMsWUFBRCxDQUEx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LEVBQVUsS0FBS2pCLE1BQUwsQ0FBWW1CLE9BQXRCLENBQWxCLENBREYsS0FFSyxNQUFNbkMsWUFBWSxDQUFDaUMsT0FBRCxDQUFsQjtBQUNOOztBQUVELFFBQUksQ0FBQyxLQUFLakIsTUFBTCxDQUFZa0IsSUFBakIsRUFBdUI7QUFDckJ6QyxNQUFBQSxLQUFLLENBQUMsZ0RBQUQsQ0FBTCxDQURxQixDQUVyQjtBQUNBOztBQUNBLFdBQUt1QixNQUFMLENBQVk2QixTQUFaLEdBQXdCL0MsVUFBVSxDQUFDa0QsZUFBWCxDQUEyQjtBQUNqRCtDLFFBQUFBLGFBQWEsRUFBRTtBQURrQyxPQUEzQixDQUF4QjtBQUdEOztBQUVELFVBQU01QixHQUFHLEdBQUcsTUFBTSxLQUFLbkQsTUFBTCxDQUFZNkIsU0FBWixDQUFzQkUsUUFBdEIsQ0FBK0JkLE9BQS9CLENBQWxCO0FBQ0F4QyxJQUFBQSxLQUFLLENBQUMsY0FBRCxDQUFMO0FBQ0EwRSxJQUFBQSxHQUFHLENBQUM2QixlQUFKLEdBQXNCL0QsT0FBdEI7QUFDQSxXQUFPa0MsR0FBUDtBQUNEOztBQS9RUzs7QUFrUlo4QixNQUFNLENBQUNDLE9BQVAsR0FBaUJwRixLQUFqQiIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IGZzID0gcmVxdWlyZSgnZnMnKTtcbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5jb25zdCBJMThOID0gcmVxdWlyZSgnQGxhZGpzL2kxOG4nKTtcbmNvbnN0IF8gPSByZXF1aXJlKCdsb2Rhc2gnKTtcbmNvbnN0IGF1dG9CaW5kID0gcmVxdWlyZSgnYXV0by1iaW5kJyk7XG5jb25zdCBjb25zb2xpZGF0ZSA9IHJlcXVpcmUoJ2NvbnNvbGlkYXRlJyk7XG5jb25zdCBkZWJ1ZyA9IHJlcXVpcmUoJ2RlYnVnJykoJ2VtYWlsLXRlbXBsYXRlcycpO1xuY29uc3QgZ2V0UGF0aHMgPSByZXF1aXJlKCdnZXQtcGF0aHMnKTtcbmNvbnN0IGh0bWxUb1RleHQgPSByZXF1aXJlKCdodG1sLXRvLXRleHQnKTtcbmNvbnN0IGlzID0gcmVxdWlyZSgnQHNpbmRyZXNvcmh1cy9pcycpO1xuY29uc3QganVpY2UgPSByZXF1aXJlKCdqdWljZScpO1xuY29uc3Qgbm9kZW1haWxlciA9IHJlcXVpcmUoJ25vZGVtYWlsZXInKTtcbmNvbnN0IHBpZnkgPSByZXF1aXJlKCdwaWZ5Jyk7XG5jb25zdCBwcmV2aWV3RW1haWwgPSByZXF1aXJlKCdwcmV2aWV3LWVtYWlsJyk7XG5cbi8vIHByb21pc2UgdmVyc2lvbiBvZiBganVpY2UuanVpY2VSZXNvdXJjZXNgXG5jb25zdCBqdWljZVJlc291cmNlcyA9IChodG1sLCBvcHRpb25zKSA9PiB7XG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAganVpY2UuanVpY2VSZXNvdXJjZXMoaHRtbCwgb3B0aW9ucywgKGVyciwgaHRtbCkgPT4ge1xuICAgICAgaWYgKGVycikgcmV0dXJuIHJlamVjdChlcnIpO1xuICAgICAgcmVzb2x2ZShodG1sKTtcbiAgICB9KTtcbiAgfSk7XG59O1xuXG5jb25zdCBlbnYgPSAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgfHwgJ2RldmVsb3BtZW50JykudG9Mb3dlckNhc2UoKTtcbmNvbnN0IHN0YXQgPSBwaWZ5KGZzLnN0YXQpO1xuY29uc3QgcmVhZEZpbGUgPSBwaWZ5KGZzLnJlYWRGaWxlKTtcblxuY2xhc3MgRW1haWwge1xuICBjb25zdHJ1Y3Rvcihjb25maWcgPSB7fSkge1xuICAgIGRlYnVnKCdjb25maWcgcGFzc2VkICVPJywgY29uZmlnKTtcblxuICAgIC8vIDIueCBiYWNrd2FyZHMgY29tcGF0aWJsZSBzdXBwb3J0XG4gICAgaWYgKGNvbmZpZy5qdWljZU9wdGlvbnMpIHtcbiAgICAgIGNvbmZpZy5qdWljZVJlc291cmNlcyA9IGNvbmZpZy5qdWljZU9wdGlvbnM7XG4gICAgICBkZWxldGUgY29uZmlnLmp1aWNlT3B0aW9ucztcbiAgICB9XG5cbiAgICBpZiAoY29uZmlnLmRpc2FibGVKdWljZSkge1xuICAgICAgY29uZmlnLmp1aWNlID0gZmFsc2U7XG4gICAgICBkZWxldGUgY29uZmlnLmRpc2FibGVKdWljZTtcbiAgICB9XG5cbiAgICBpZiAoY29uZmlnLnJlbmRlcikge1xuICAgICAgY29uZmlnLmN1c3RvbVJlbmRlciA9IHRydWU7XG4gICAgfVxuXG4gICAgdGhpcy5jb25maWcgPSBfLm1lcmdlKFxuICAgICAge1xuICAgICAgICB2aWV3czoge1xuICAgICAgICAgIC8vIGRpcmVjdG9yeSB3aGVyZSBlbWFpbCB0ZW1wbGF0ZXMgcmVzaWRlXG4gICAgICAgICAgcm9vdDogcGF0aC5yZXNvbHZlKCdlbWFpbHMnKSxcbiAgICAgICAgICBvcHRpb25zOiB7XG4gICAgICAgICAgICAvLyBkZWZhdWx0IGZpbGUgZXh0ZW5zaW9uIGZvciB0ZW1wbGF0ZVxuICAgICAgICAgICAgZXh0ZW5zaW9uOiAncHVnJyxcbiAgICAgICAgICAgIG1hcDoge1xuICAgICAgICAgICAgICBoYnM6ICdoYW5kbGViYXJzJyxcbiAgICAgICAgICAgICAgbmprOiAnbnVuanVja3MnXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgZW5naW5lU291cmNlOiBjb25zb2xpZGF0ZVxuICAgICAgICAgIH0sXG4gICAgICAgICAgLy8gbG9jYWxzIHRvIHBhc3MgdG8gdGVtcGxhdGVzIGZvciByZW5kZXJpbmdcbiAgICAgICAgICBsb2NhbHM6IHtcbiAgICAgICAgICAgIC8vIHR1cm4gb24gY2FjaGluZyBmb3Igbm9uLWRldmVsb3BtZW50IGVudmlyb25tZW50c1xuICAgICAgICAgICAgY2FjaGU6ICFbJ2RldmVsb3BtZW50JywgJ3Rlc3QnXS5pbmNsdWRlcyhlbnYpLFxuICAgICAgICAgICAgLy8gcHJldHR5IGlzIGF1dG9tYXRpY2FsbHkgc2V0IHRvIGBmYWxzZWAgZm9yIHN1YmplY3QvdGV4dFxuICAgICAgICAgICAgcHJldHR5OiB0cnVlXG4gICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICAvLyA8aHR0cHM6Ly9ub2RlbWFpbGVyLmNvbS9tZXNzYWdlLz5cbiAgICAgICAgbWVzc2FnZToge30sXG4gICAgICAgIHNlbmQ6ICFbJ2RldmVsb3BtZW50JywgJ3Rlc3QnXS5pbmNsdWRlcyhlbnYpLFxuICAgICAgICBwcmV2aWV3OiBlbnYgPT09ICdkZXZlbG9wbWVudCcsXG4gICAgICAgIC8vIDxodHRwczovL2dpdGh1Yi5jb20vbGFkanMvaTE4bj5cbiAgICAgICAgLy8gc2V0IHRvIGFuIG9iamVjdCB0byBjb25maWd1cmUgYW5kIGVuYWJsZSBpdFxuICAgICAgICBpMThuOiBmYWxzZSxcbiAgICAgICAgLy8gcGFzcyBhIGN1c3RvbSByZW5kZXIgZnVuY3Rpb24gaWYgbmVjZXNzYXJ5XG4gICAgICAgIHJlbmRlcjogdGhpcy5yZW5kZXIuYmluZCh0aGlzKSxcbiAgICAgICAgY3VzdG9tUmVuZGVyOiBmYWxzZSxcbiAgICAgICAgLy8gZm9yY2UgdGV4dC1vbmx5IHJlbmRlcmluZyBvZiB0ZW1wbGF0ZSAoZGlzcmVnYXJkcyB0ZW1wbGF0ZSBmb2xkZXIpXG4gICAgICAgIHRleHRPbmx5OiBmYWxzZSxcbiAgICAgICAgLy8gPGh0dHBzOi8vZ2l0aHViLmNvbS93ZXJrODUvbm9kZS1odG1sLXRvLXRleHQ+XG4gICAgICAgIGh0bWxUb1RleHQ6IHtcbiAgICAgICAgICBpZ25vcmVJbWFnZTogdHJ1ZVxuICAgICAgICB9LFxuICAgICAgICBzdWJqZWN0UHJlZml4OiBmYWxzZSxcbiAgICAgICAgLy8gPGh0dHBzOi8vZ2l0aHViLmNvbS9BdXRvbWF0dGljL2p1aWNlPlxuICAgICAgICBqdWljZTogdHJ1ZSxcbiAgICAgICAganVpY2VSZXNvdXJjZXM6IHtcbiAgICAgICAgICBwcmVzZXJ2ZUltcG9ydGFudDogdHJ1ZSxcbiAgICAgICAgICB3ZWJSZXNvdXJjZXM6IHtcbiAgICAgICAgICAgIHJlbGF0aXZlVG86IHBhdGgucmVzb2x2ZSgnYnVpbGQnKSxcbiAgICAgICAgICAgIGltYWdlczogZmFsc2VcbiAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIC8vIHBhc3MgYSB0cmFuc3BvcnQgY29uZmlndXJhdGlvbiBvYmplY3Qgb3IgYSB0cmFuc3BvcnQgaW5zdGFuY2VcbiAgICAgICAgLy8gKGUuZy4gYW4gaW5zdGFuY2UgaXMgY3JlYXRlZCB2aWEgYG5vZGVtYWlsZXIuY3JlYXRlVHJhbnNwb3J0YClcbiAgICAgICAgLy8gPGh0dHBzOi8vbm9kZW1haWxlci5jb20vdHJhbnNwb3J0cy8+XG4gICAgICAgIHRyYW5zcG9ydDoge31cbiAgICAgIH0sXG4gICAgICBjb25maWdcbiAgICApO1xuXG4gICAgLy8gb3ZlcnJpZGUgZXhpc3RpbmcgbWV0aG9kXG4gICAgdGhpcy5yZW5kZXIgPSB0aGlzLmNvbmZpZy5yZW5kZXI7XG5cbiAgICBpZiAoIV8uaXNGdW5jdGlvbih0aGlzLmNvbmZpZy50cmFuc3BvcnQuc2VuZE1haWwpKVxuICAgICAgdGhpcy5jb25maWcudHJhbnNwb3J0ID0gbm9kZW1haWxlci5jcmVhdGVUcmFuc3BvcnQodGhpcy5jb25maWcudHJhbnNwb3J0KTtcblxuICAgIGRlYnVnKCd0cmFuc2Zvcm1lZCBjb25maWcgJU8nLCB0aGlzLmNvbmZpZyk7XG5cbiAgICBhdXRvQmluZCh0aGlzKTtcbiAgfVxuXG4gIC8vIHNob3J0aGFuZCB1c2Ugb2YgYGp1aWNlUmVzb3VyY2VzYCB3aXRoIHRoZSBjb25maWdcbiAgLy8gKG1haW5seSBmb3IgY3VzdG9tIHJlbmRlcnMgbGlrZSBmcm9tIGEgZGF0YWJhc2UpXG4gIGp1aWNlUmVzb3VyY2VzKGh0bWwpIHtcbiAgICByZXR1cm4ganVpY2VSZXNvdXJjZXMoaHRtbCwgdGhpcy5jb25maWcuanVpY2VSZXNvdXJjZXMpO1xuICB9XG5cbiAgLy8gYSBzaW1wbGUgaGVscGVyIGZ1bmN0aW9uIHRoYXQgZ2V0cyB0aGUgYWN0dWFsIGZpbGUgcGF0aCBmb3IgdGhlIHRlbXBsYXRlXG4gIGFzeW5jIGdldFRlbXBsYXRlUGF0aCh0ZW1wbGF0ZSkge1xuICAgIGNvbnN0IFtyb290LCB2aWV3XSA9IHBhdGguaXNBYnNvbHV0ZSh0ZW1wbGF0ZSlcbiAgICAgID8gW3BhdGguZGlybmFtZSh0ZW1wbGF0ZSksIHBhdGguYmFzZW5hbWUodGVtcGxhdGUpXVxuICAgICAgOiBbdGhpcy5jb25maWcudmlld3Mucm9vdCwgdGVtcGxhdGVdO1xuICAgIGNvbnN0IHBhdGhzID0gYXdhaXQgZ2V0UGF0aHMoXG4gICAgICByb290LFxuICAgICAgdmlldyxcbiAgICAgIHRoaXMuY29uZmlnLnZpZXdzLm9wdGlvbnMuZXh0ZW5zaW9uXG4gICAgKTtcbiAgICBjb25zdCBmaWxlUGF0aCA9IHBhdGgucmVzb2x2ZShyb290LCBwYXRocy5yZWwpO1xuICAgIHJldHVybiB7IGZpbGVQYXRoLCBwYXRocyB9O1xuICB9XG5cbiAgLy8gcmV0dXJucyB0cnVlIG9yIGZhbHNlIGlmIGEgdGVtcGxhdGUgZXhpc3RzXG4gIC8vICh1c2VzIHNhbWUgbG9vay11cCBhcHByb2FjaCBhcyBgcmVuZGVyYCBmdW5jdGlvbilcbiAgYXN5bmMgdGVtcGxhdGVFeGlzdHModmlldykge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IGZpbGVQYXRoIH0gPSBhd2FpdCB0aGlzLmdldFRlbXBsYXRlUGF0aCh2aWV3KTtcbiAgICAgIGNvbnN0IHN0YXRzID0gYXdhaXQgc3RhdChmaWxlUGF0aCk7XG4gICAgICBpZiAoIXN0YXRzLmlzRmlsZSgpKSB0aHJvdyBuZXcgRXJyb3IoYCR7ZmlsZVBhdGh9IHdhcyBub3QgYSBmaWxlYCk7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGRlYnVnKCd0ZW1wbGF0ZUV4aXN0cycsIGVycik7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgY2hlY2tBbmRSZW5kZXIodHlwZSwgdGVtcGxhdGUsIGxvY2Fscykge1xuICAgIGNvbnN0IHN0ciA9IGAke3RlbXBsYXRlfS8ke3R5cGV9YDtcbiAgICBpZiAoIXRoaXMuY29uZmlnLmN1c3RvbVJlbmRlcikge1xuICAgICAgY29uc3QgZXhpc3RzID0gYXdhaXQgdGhpcy50ZW1wbGF0ZUV4aXN0cyhzdHIpO1xuICAgICAgaWYgKCFleGlzdHMpIHJldHVybjtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5yZW5kZXIoc3RyLCB7XG4gICAgICAuLi5sb2NhbHMsXG4gICAgICAuLi4odHlwZSA9PT0gJ2h0bWwnID8ge30gOiB7IHByZXR0eTogZmFsc2UgfSlcbiAgICB9KTtcbiAgfVxuXG4gIC8vIHByb21pc2UgdmVyc2lvbiBvZiBjb25zb2xpZGF0ZSdzIHJlbmRlclxuICAvLyBpbnNwaXJlZCBieSBrb2Etdmlld3MgYW5kIHJlLXVzZXMgdGhlIHNhbWUgY29uZmlnXG4gIC8vIDxodHRwczovL2dpdGh1Yi5jb20vcXVlY2tlenova29hLXZpZXdzPlxuICBhc3luYyByZW5kZXIodmlldywgbG9jYWxzID0ge30pIHtcbiAgICBjb25zdCB7IG1hcCwgZW5naW5lU291cmNlIH0gPSB0aGlzLmNvbmZpZy52aWV3cy5vcHRpb25zO1xuICAgIGNvbnN0IHsgZmlsZVBhdGgsIHBhdGhzIH0gPSBhd2FpdCB0aGlzLmdldFRlbXBsYXRlUGF0aCh2aWV3KTtcbiAgICBpZiAocGF0aHMuZXh0ID09PSAnaHRtbCcgJiYgIW1hcCkge1xuICAgICAgY29uc3QgcmVzID0gYXdhaXQgcmVhZEZpbGUoZmlsZVBhdGgsICd1dGY4Jyk7XG4gICAgICByZXR1cm4gcmVzO1xuICAgIH1cblxuICAgIGNvbnN0IGVuZ2luZU5hbWUgPSBtYXAgJiYgbWFwW3BhdGhzLmV4dF0gPyBtYXBbcGF0aHMuZXh0XSA6IHBhdGhzLmV4dDtcbiAgICBjb25zdCByZW5kZXJGbiA9IGVuZ2luZVNvdXJjZVtlbmdpbmVOYW1lXTtcbiAgICBpZiAoIWVuZ2luZU5hbWUgfHwgIXJlbmRlckZuKVxuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgRW5naW5lIG5vdCBmb3VuZCBmb3IgdGhlIFwiLiR7cGF0aHMuZXh0fVwiIGZpbGUgZXh0ZW5zaW9uYFxuICAgICAgKTtcblxuICAgIGlmIChfLmlzT2JqZWN0KHRoaXMuY29uZmlnLmkxOG4pKSB7XG4gICAgICBjb25zdCBpMThuID0gbmV3IEkxOE4oeyAuLi50aGlzLmNvbmZpZy5pMThuLCByZWdpc3RlcjogbG9jYWxzIH0pO1xuXG4gICAgICAvLyBzdXBwb3J0IGBsb2NhbHMudXNlci5sYXN0X2xvY2FsZWBcbiAgICAgIC8vIChlLmcuIGZvciA8aHR0cHM6Ly9sYWQuanMub3JnPilcbiAgICAgIGlmIChfLmlzT2JqZWN0KGxvY2Fscy51c2VyKSAmJiBfLmlzU3RyaW5nKGxvY2Fscy51c2VyLmxhc3RfbG9jYWxlKSlcbiAgICAgICAgbG9jYWxzLmxvY2FsZSA9IGxvY2Fscy51c2VyLmxhc3RfbG9jYWxlO1xuXG4gICAgICBpZiAoXy5pc1N0cmluZyhsb2NhbHMubG9jYWxlKSkgaTE4bi5zZXRMb2NhbGUobG9jYWxzLmxvY2FsZSk7XG4gICAgfVxuXG4gICAgY29uc3QgcmVzID0gYXdhaXQgcGlmeShyZW5kZXJGbikoZmlsZVBhdGgsIGxvY2Fscyk7XG4gICAgLy8gdHJhbnNmb3JtIHRoZSBodG1sIHdpdGgganVpY2UgdXNpbmcgcmVtb3RlIHBhdGhzXG4gICAgLy8gZ29vZ2xlIG5vdyBzdXBwb3J0cyBtZWRpYSBxdWVyaWVzXG4gICAgLy8gaHR0cHM6Ly9kZXZlbG9wZXJzLmdvb2dsZS5jb20vZ21haWwvZGVzaWduL3JlZmVyZW5jZS9zdXBwb3J0ZWRfY3NzXG4gICAgaWYgKCF0aGlzLmNvbmZpZy5qdWljZSkgcmV0dXJuIHJlcztcbiAgICBjb25zdCBodG1sID0gYXdhaXQgdGhpcy5qdWljZVJlc291cmNlcyhyZXMpO1xuICAgIHJldHVybiBodG1sO1xuICB9XG5cbiAgYXN5bmMgcmVuZGVyQWxsKHRlbXBsYXRlLCBsb2NhbHMgPSB7fSwgbm9kZW1haWxlck1lc3NhZ2UgPSB7fSkge1xuICAgIGNvbnN0IG1lc3NhZ2UgPSB7IC4uLm5vZGVtYWlsZXJNZXNzYWdlIH07XG5cbiAgICBpZiAodGVtcGxhdGUpIHtcbiAgICAgIGNvbnN0IFtzdWJqZWN0LCBodG1sLCB0ZXh0XSA9IGF3YWl0IFByb21pc2UuYWxsKFxuICAgICAgICBbJ3N1YmplY3QnLCAnaHRtbCcsICd0ZXh0J10ubWFwKHR5cGUgPT5cbiAgICAgICAgICB0aGlzLmNoZWNrQW5kUmVuZGVyKHR5cGUsIHRlbXBsYXRlLCBsb2NhbHMpXG4gICAgICAgIClcbiAgICAgICk7XG5cbiAgICAgIGlmIChzdWJqZWN0KSBtZXNzYWdlLnN1YmplY3QgPSBzdWJqZWN0LnRyaW0oKTtcbiAgICAgIGlmIChodG1sKSBtZXNzYWdlLmh0bWwgPSBodG1sO1xuICAgICAgaWYgKHRleHQpIG1lc3NhZ2UudGV4dCA9IHRleHQ7XG4gICAgfVxuXG4gICAgaWYgKG1lc3NhZ2Uuc3ViamVjdCAmJiB0aGlzLmNvbmZpZy5zdWJqZWN0UHJlZml4KVxuICAgICAgbWVzc2FnZS5zdWJqZWN0ID0gdGhpcy5jb25maWcuc3ViamVjdFByZWZpeCArIG1lc3NhZ2Uuc3ViamVjdDtcblxuICAgIGlmICh0aGlzLmNvbmZpZy5odG1sVG9UZXh0ICYmIG1lc3NhZ2UuaHRtbCAmJiAhbWVzc2FnZS50ZXh0KVxuICAgICAgLy8gd2UnZCB1c2Ugbm9kZW1haWxlci1odG1sLXRvLXRleHQgcGx1Z2luXG4gICAgICAvLyBidXQgd2UgcmVhbGx5IGRvbid0IG5lZWQgdG8gc3VwcG9ydCBjaWRcbiAgICAgIC8vIDxodHRwczovL2dpdGh1Yi5jb20vYW5kcmlzOS9ub2RlbWFpbGVyLWh0bWwtdG8tdGV4dD5cbiAgICAgIG1lc3NhZ2UudGV4dCA9IGh0bWxUb1RleHQuZnJvbVN0cmluZyhcbiAgICAgICAgbWVzc2FnZS5odG1sLFxuICAgICAgICB0aGlzLmNvbmZpZy5odG1sVG9UZXh0XG4gICAgICApO1xuXG4gICAgLy8gaWYgd2Ugb25seSB3YW50IGEgdGV4dC1iYXNlZCB2ZXJzaW9uIG9mIHRoZSBlbWFpbFxuICAgIGlmICh0aGlzLmNvbmZpZy50ZXh0T25seSkgZGVsZXRlIG1lc3NhZ2UuaHRtbDtcblxuICAgIC8vIGlmIG5vIHN1YmplY3QsIGh0bWwsIG9yIHRleHQgY29udGVudCBleGlzdHMgdGhlbiB3ZSBzaG91bGRcbiAgICAvLyB0aHJvdyBhbiBlcnJvciB0aGF0IHNheXMgYXQgbGVhc3Qgb25lIG11c3QgYmUgZm91bmRcbiAgICAvLyBvdGhlcndpc2UgdGhlIGVtYWlsIHdvdWxkIGJlIGJsYW5rIChkZWZlYXRzIHB1cnBvc2Ugb2YgZW1haWwtdGVtcGxhdGVzKVxuICAgIGlmIChcbiAgICAgICghaXMuc3RyaW5nKG1lc3NhZ2Uuc3ViamVjdCkgfHxcbiAgICAgICAgaXMuZW1wdHlTdHJpbmdPcldoaXRlc3BhY2UobWVzc2FnZS5zdWJqZWN0KSkgJiZcbiAgICAgICghaXMuc3RyaW5nKG1lc3NhZ2UudGV4dCkgfHwgaXMuZW1wdHlTdHJpbmdPcldoaXRlc3BhY2UobWVzc2FnZS50ZXh0KSkgJiZcbiAgICAgICghaXMuc3RyaW5nKG1lc3NhZ2UuaHRtbCkgfHwgaXMuZW1wdHlTdHJpbmdPcldoaXRlc3BhY2UobWVzc2FnZS5odG1sKSkgJiZcbiAgICAgIF8uaXNBcnJheShtZXNzYWdlLmF0dGFjaG1lbnRzKSAmJlxuICAgICAgXy5pc0VtcHR5KG1lc3NhZ2UuYXR0YWNobWVudHMpXG4gICAgKVxuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgTm8gY29udGVudCB3YXMgcGFzc2VkIGZvciBzdWJqZWN0LCBodG1sLCB0ZXh0LCBub3IgYXR0YWNobWVudHMgbWVzc2FnZSBwcm9wcy4gQ2hlY2sgdGhhdCB0aGUgZmlsZXMgZm9yIHRoZSB0ZW1wbGF0ZSBcIiR7dGVtcGxhdGV9XCIgZXhpc3QuYFxuICAgICAgKTtcblxuICAgIHJldHVybiBtZXNzYWdlO1xuICB9XG5cbiAgYXN5bmMgc2VuZChvcHRpb25zID0ge30pIHtcbiAgICBvcHRpb25zID0ge1xuICAgICAgdGVtcGxhdGU6ICcnLFxuICAgICAgbWVzc2FnZToge30sXG4gICAgICBsb2NhbHM6IHt9LFxuICAgICAgLi4ub3B0aW9uc1xuICAgIH07XG5cbiAgICBsZXQgeyB0ZW1wbGF0ZSwgbWVzc2FnZSwgbG9jYWxzIH0gPSBvcHRpb25zO1xuXG4gICAgY29uc3QgYXR0YWNobWVudHMgPVxuICAgICAgbWVzc2FnZS5hdHRhY2htZW50cyB8fCB0aGlzLmNvbmZpZy5tZXNzYWdlLmF0dGFjaG1lbnRzIHx8IFtdO1xuXG4gICAgbWVzc2FnZSA9IF8uZGVmYXVsdHNEZWVwKFxuICAgICAge30sXG4gICAgICBfLm9taXQobWVzc2FnZSwgJ2F0dGFjaG1lbnRzJyksXG4gICAgICBfLm9taXQodGhpcy5jb25maWcubWVzc2FnZSwgJ2F0dGFjaG1lbnRzJylcbiAgICApO1xuICAgIGxvY2FscyA9IF8uZGVmYXVsdHNEZWVwKHt9LCB0aGlzLmNvbmZpZy52aWV3cy5sb2NhbHMsIGxvY2Fscyk7XG5cbiAgICBpZiAoYXR0YWNobWVudHMpIG1lc3NhZ2UuYXR0YWNobWVudHMgPSBhdHRhY2htZW50cztcblxuICAgIGRlYnVnKCd0ZW1wbGF0ZSAlcycsIHRlbXBsYXRlKTtcbiAgICBkZWJ1ZygnbWVzc2FnZSAlTycsIG1lc3NhZ2UpO1xuICAgIGRlYnVnKCdsb2NhbHMgKGtleXMgb25seSk6ICVPJywgT2JqZWN0LmtleXMobG9jYWxzKSk7XG5cbiAgICAvLyBnZXQgYWxsIGF2YWlsYWJsZSB0ZW1wbGF0ZXNcbiAgICBjb25zdCBvYmogPSBhd2FpdCB0aGlzLnJlbmRlckFsbCh0ZW1wbGF0ZSwgbG9jYWxzLCBtZXNzYWdlKTtcblxuICAgIC8vIGFzc2lnbiB0aGUgb2JqZWN0IHZhcmlhYmxlcyBvdmVyIHRvIHRoZSBtZXNzYWdlXG4gICAgT2JqZWN0LmFzc2lnbihtZXNzYWdlLCBvYmopO1xuXG4gICAgaWYgKHRoaXMuY29uZmlnLnByZXZpZXcpIHtcbiAgICAgIGRlYnVnKCd1c2luZyBgcHJldmlldy1lbWFpbGAgdG8gcHJldmlldyBlbWFpbCcpO1xuICAgICAgaWYgKF8uaXNPYmplY3QodGhpcy5jb25maWcucHJldmlldykpXG4gICAgICAgIGF3YWl0IHByZXZpZXdFbWFpbChtZXNzYWdlLCB0aGlzLmNvbmZpZy5wcmV2aWV3KTtcbiAgICAgIGVsc2UgYXdhaXQgcHJldmlld0VtYWlsKG1lc3NhZ2UpO1xuICAgIH1cblxuICAgIGlmICghdGhpcy5jb25maWcuc2VuZCkge1xuICAgICAgZGVidWcoJ3NlbmQgZGlzYWJsZWQgc28gd2UgYXJlIGVuc3VyaW5nIEpTT05UcmFuc3BvcnQnKTtcbiAgICAgIC8vIDxodHRwczovL2dpdGh1Yi5jb20vbm9kZW1haWxlci9ub2RlbWFpbGVyL2lzc3Vlcy83OTg+XG4gICAgICAvLyBpZiAodGhpcy5jb25maWcudHJhbnNwb3J0Lm5hbWUgIT09ICdKU09OVHJhbnNwb3J0JylcbiAgICAgIHRoaXMuY29uZmlnLnRyYW5zcG9ydCA9IG5vZGVtYWlsZXIuY3JlYXRlVHJhbnNwb3J0KHtcbiAgICAgICAganNvblRyYW5zcG9ydDogdHJ1ZVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgcmVzID0gYXdhaXQgdGhpcy5jb25maWcudHJhbnNwb3J0LnNlbmRNYWlsKG1lc3NhZ2UpO1xuICAgIGRlYnVnKCdtZXNzYWdlIHNlbnQnKTtcbiAgICByZXMub3JpZ2luYWxNZXNzYWdlID0gbWVzc2FnZTtcbiAgICByZXR1cm4gcmVzO1xuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gRW1haWw7XG4iXX0=